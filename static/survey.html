<html>
<head>
<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;"/>
<title>QuantifiedSelf survey</title>
<link rel="stylesheet" type="text/css" href="css/normalize.css"/>
<style>
body {

}
td,th {
  text-align: center;
  width: 2em;
}
.sliderBar {
  position: relative;
  top: 0px;
  left: 0px;
  width: 0px;
  height: 100%;
  background-color: #22e;
}
.sliderLabel {
  float: left;
  width: 100%;
  height: 100%;
  color: #ffa;
  z-index: 100;
  position: relative;
  text-align: center;
  vertical-align: center;
}
#leftLabel {
  position: absolute;
  left: 0;
  bottom: 0;
  width: 33%;
}
#rightLabel {
  position: absolute;
  right: 0;
  bottom: 0;
  width: 33%;
}
#centerLabel {
  position: absolute;
  left: 33%;
  bottom: 0;
  height: 100%;
  width: 33%;
  text-align: center;
}
.sliderLabels {
  display: block;
  position: absolute;
  top: 60%;
  width: 100%;
  height: 10%;
}
#message {
  position: absolute;
  width: 100%;
  top: 0;
  height: 10%;
}
#questionText {
  position: absolute;
  width: 100%;
  top: 10%;
  height: 25%;
}
#submitButton {
  position: absolute;
  top: 35%;
  height: 25%;
  width: 50%;
  right: 0%;
}
#skipButton {
  position: absolute;
  top: 35%;
  height: 25%;
  width: 50%;
  left: 0%;
}
.sliderBackground {
  position: absolute;
  top: 70%;
  height: 30%;
  width: 100%;
  text-size: 100%;
  background-color: #aaf;
}
</style>
</head>
<body>
<div id="authForm">
<input id="username" type="text"></input>
<input id="password" type="password"></input>
<input type="button" id="authButton" value="Authenticate">
</div>
<div id="message">
</div>
<div id="surveyForm" style="display: none;">
<form>
<div id="questionText">
</div>
<div class="sliderLabels">
<div id="leftLabel"></div>
<div id="centerLabel"></div>
<div id="rightLabel"></div>
</div>
<div class="choiceSlider"></div>
<tr>
<input type="button" value="Submit" id="submitButton">
<input type="button" value="Skip" id="skipButton">
</div>
</form>
<input type="button" value="Re-fetch" id="refetchButton" style="display: none;">
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script> 
<script src="lib/hammer.min.js"></script>
<script src="js/slider.js"></script>
<script type="text/javascript" language="javascript">
var forcePending = false;

$(function() {
  var slider = addSlider($(".choiceSlider"), {
    onChange: function(val) {
      $("#submitButton").prop("disabled", false);
    },
  });
  var currentQ;
  var username, password;
  var t0;
  var statusbar = {};

  function setStatus(key, val) {
    var msgs = [];

    statusbar[key] = val;

    if (statusbar.queueSizeMessage !== undefined) {
      msgs.push(statusbar.queueSizeMessage);
    }

    if (statusbar.answerTimeMs !== undefined) {
      msgs.push("Last answer time: " + statusbar.answerTimeMs + "ms");
    }

    if (statusbar.answer !== undefined) {
      msgs.push("Last answer: " + statusbar.answer + "%");
    }

    $("#message").html(msgs.join(", "));
  }

  function fetchQuestion() {
      var url = "/qs-api/u/" + username + "/questions/pending",
          hardLimit = 20;
      $("#refetchButton").show();
      $.ajax(url, {
          username: username,
          password: password,
          data: {
            limit: hardLimit,
            force: forcePending,
            types: "question",
          },
      }).done(function(data) {
          var n = data["pending"].length,
              msg;
          if (n > 0) {
            loadQuestion(data["pending"][0]);
            $("#refetchButton").hide();
            if (n == 1) {
              msg = "1 item pending";
            } else if (n >= hardLimit) {
              msg = "" + hardLimit + " or more items pending";
            } else {
              msg = "" + n + " items pending";
            }
          } else {
            msg = "No items pending";
          }
          setStatus("queueSizeMessage", msg);
          t0 = new Date().getTime();
      });
  }
  function skipQuestion(q) {
      var url = "/qs-api/u/" + username + "/questions/" + q.id + "/skip";
      $.ajax(url, {
          username: username,
          password: password,
          type: "POST",
      }).done(function() {
          fetchQuestion();
      });
  }
  function postAnswer(q, v) {
      var url = "/qs-api/u/" + username + "/questions/" + q.id + "/answer";
      var t1 = new Date().getTime(),
          latency = t1 - t0;
      var data = JSON.stringify({
          value: v * 0.01,
          latency_ms: latency,
      });
      setStatus("answer", v);
      setStatus("answerTimeMs", latency);
      $("#surveyForm").hide();
      $.ajax(url, {
          username: username,
          password: password,
          type: "POST",
          contentType: "application/json; charset: utf-8",
          dataType: "json",
          data: data,
      }).done(function() {
          fetchQuestion();
      });
  }
  function loadQuestion(q) {
    $("#questionText").html(q.text);
    $("#leftLabel").html(q.labels.low);
    $("#centerLabel").html(q.labels.middle || "");
    $("#rightLabel").html(q.labels.high);
    $("#surveyForm").show();
    $("#refetchButton").hide();
    slider.reset();
    $("#submitButton").prop("disabled", true);
    currentQ = q;
  }
  $("#authButton").click(function() {
    username = $("#username").val();
    password = $("#password").val();
    $("#authForm").hide();
    $("#refetchButton").show();
    fetchQuestion();
  });
  $("#refetchButton").click(function() {
    fetchQuestion();
  });
  $("#submitButton").click(function() {
    postAnswer(currentQ, slider.getValue());
    currentQ = null;
  });
  $("#skipButton").click(function() {
    skipQuestion(currentQ);
    currentQ = null;
  });
});
</script>
</html>
